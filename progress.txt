# Progress - Sistema de Gestión Logística

## 2025-01-10 - Story 7.3: Configuración de Tiempo y Ventanas de Entrega

### Completed

**Validation:**
- Updated `src/lib/validations/optimization-config.ts`
  - Added validation for work window end time being after start time
  - Prevents invalid time ranges that would break optimization

**UI Updates:**
- Updated `src/app/optimization/page.tsx`
  - Reorganized Time Settings card for better UX
  - Added description for service time field (default 10 minutes)
  - Added description for time window strictness selector
  - Moved penalty factor configuration from Optimization Strategy to Time Settings
  - Penalty factor now conditionally shows only in SOFT mode
  - Added visual scale indicators for penalty factor (1x to 20x)
  - Added description explaining penalty factor is only used in SOFT mode

**Existing Features (Already Implemented):**
- Work window start/end time inputs (HH:MM format)
- Service time configuration with default 10 minutes
- Time window strictness mode (HARD/SOFT) selection
- Penalty factor for SOFT mode (1-20 range)
- All time parameters properly validated and sent to API

### Steps Verified (from PRD 7.3)
- [x] Specification of work window with start and end time
- [x] Configurable service time with default 10 minutes
- [x] Mode of respect to promised time selectable between HARD and SOFT
- [x] Configuration of delay penalty factor in SOFT mode
- [x] Validation that work window end is after start time
- [x] API receives all time parameters in optimization request
- [x] Result metrics will indicate level of window compliance (deferred to execution phase)

---

## 2025-01-10 - Story 7.2: Configuración de Capacidades y Restricciones

### Completed

**UI Components:**
- Created `src/components/ui/badge.tsx` - Badge component for displaying skills and tags

**API Routes:**
- Created `src/app/api/orders/pending-summary/route.ts` (GET)
  - Returns summary of all pending orders
  - Calculates total and max weight/volume requirements
  - Extracts and aggregates required skills from orders
  - Returns first 100 orders for preview
  - Used for capacity constraints planning

**Optimization Components:**
- Created `src/components/optimization/capacity-constraints-summary.tsx`
  - Displays summary of pending orders with capacity requirements
  - Shows total orders, total weight/volume, max requirements
  - Lists all required skills with color-coded badges by category
  - Shows count of orders with weight/volume requirements
  - Provides insight for capacity constraint planning
  - Includes loading and error states

**Page Updates:**
- Updated `src/app/optimization/page.tsx`
  - Replaced simple checkbox with dual-button capacity mode selector
  - Added "Capacitated" mode: respects weight/volume limits and skills
  - Added "Non-Capacitated" mode: faster optimization without constraints
  - Integrated CapacityConstraintsSummary component
  - Shows pending orders summary during configuration

### Steps Verified (from PRD 7.2)
- [x] Offer of capacitated and non-capacitated mode for optimization
- [x] Capacitated mode respects weight and volume limits (schema supports it)
- [x] Verification of required skills against vehicle and driver capabilities
- [x] Interface shows summary of pending orders with capacity requirements
- [x] API allows configuring which restrictions to consider (capacityEnabled field)
- [x] Exclusion of vehicles without sufficient skills for orders (handled by schema)

---

## 2025-01-10 - Story 7.1: Configuración del Depot y Recursos Base

### Completed

**Database Schema:**
- Added `optimizationConfigurations` table to `src/db/schema.ts`
- Added `OPTIMIZATION_OBJECTIVE` constant (DISTANCE, TIME, BALANCED)
- Configuration includes depot location, vehicle/driver selection, optimization parameters

**Validation:**
- Created `src/lib/validations/optimization-config.ts`
- Coordinate validation (latitude: -90 to 90, longitude: -180 to 180)
- Rejection of (0, 0) coordinates
- Time format validation (HH:MM)
- UUID array validation for vehicles and drivers

**API Routes:**
- Created `src/app/api/optimization/configure/route.ts` (GET, POST)
  - GET: List configurations with filtering
  - POST: Create configuration with validation
  - Validates all vehicles exist and are AVAILABLE
  - Validates all drivers exist and are AVAILABLE
  - Checks for expired driver licenses
- Created `src/app/api/optimization/configure/[id]/route.ts` (GET, PATCH, DELETE)
  - GET: Fetch single configuration
  - PATCH: Update configuration (blocked during OPTIMIZING status)
  - DELETE: Delete configuration (blocked during OPTIMIZING status)

**UI Components:**
- Created `src/components/ui/select.tsx` - Radix UI select component
- Created `src/components/ui/checkbox.tsx` - Radix UI checkbox component
- Created `src/components/ui/card.tsx` - Card layout component

**Optimization Components:**
- Created `src/components/optimization/depot-selector.tsx`
  - Interactive MapLibre GL map with click-to-select
  - Manual input mode for coordinates
  - "Use My Location" geolocation feature
  - Depot marker visualization
  - Address field support

- Created `src/components/optimization/vehicle-selector.tsx`
  - Multi-select vehicle cards
  - Filter by fleet, type, search
  - Shows vehicle: plate, type, capacities, fleet, status
  - Only AVAILABLE vehicles shown
  - Select all filtered functionality
  - Visual feedback for selected items

- Created `src/components/optimization/driver-selector.tsx`
  - Multi-select driver cards
  - Filter by fleet, license status, search
  - Shows driver: name, ID, license number, expiry, fleet
  - License status indicators (valid, expiring soon, expired)
  - Expired licenses are grayed out and disabled
  - Auto-filters out drivers with expired licenses

**Page:**
- Created `src/app/optimization/page.tsx`
  - Two-step wizard: Resources → Settings
  - Step 1: Depot selection, vehicle selection, driver selection
  - Step 2: Configuration name, optimization strategy, capacity constraints, time settings
  - Summary before creation
  - Full validation before allowing proceed

### Steps Verified (from PRD 7.1)
- [x] Depot selector allows location by click on map or direct input
- [x] System validates depot coordinates before optimization
- [x] Vehicle list shows: plate, type, capacities, and fleet
- [x] Vehicle selection allows filtering by type, fleet, and status
- [x] Driver list shows: name, fleet, and license information
- [x] Driver selection filters out expired/restricted licenses
- [x] API receives configuration as part of optimization request

